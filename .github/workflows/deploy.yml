name: Deploy to production

on:
  workflow_run:
    workflows: ["CI (Bun)"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to production
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup dependencies
        run: bun install

      - name: Type check and generate SvelteKit config
        run: bun run check && bunx svelte-kit sync

      - name: Lint code
        env:
          NODE_OPTIONS: "--max-old-space-size=16384"
        run: bun run lint

      - name: Build project
        run: bun run build

      - name: Paste files to server
        run: |
          cd ~/Sky
          # Supprimer tout SAUF .env, database et .svelte-kit
          # On préserve 'database' car il contient la DB et les fichiers permanents
          find . -mindepth 1 -maxdepth 1 -not -name '.env' -not -name 'database' -not -name '.svelte-kit' -exec rm -rf {} +

          # Copier les nouveaux fichiers depuis le runner
          # Utilisation directe de github.workspace pour éviter les erreurs de chemin
          cp -r ${{ github.workspace }}/* .

      - name: Install Python dependencies
        run: |
          cd ~/Sky

          # Check if pip is installed, if not try to install it using get-pip.py
          if ! python3 -m pip --version > /dev/null 2>&1; then
            echo "Pip module not found. Attempting to install pip locally..."
            curl -sS https://bootstrap.pypa.io/get-pip.py -o get-pip.py
            python3 get-pip.py --user
            rm get-pip.py
          fi

          # Add user site-packages binary path to PATH (often ~/.local/bin)
          export PATH=$PATH:$HOME/.local/bin

          # Verify pip is now available
          python3 -m pip --version

          # Install dependencies
          python3 -m pip install -r requirements.txt --user --break-system-packages || python3 -m pip install -r requirements.txt --user

      - name: Initialize and Verify Database
        run: |
          cd ~/Sky
          # Rebuild better-sqlite3 for the current Node environment to ensure ABI compatibility
          # This fixes possible mismatch between Bun install and Node execution
          npm rebuild better-sqlite3

          # Run the integrity check script using Node (Bun does not support better-sqlite3 yet)
          node scripts/check-db-integrity.js
          
          # Migration auto des IDs si nécessaire
          node scripts/migrate-ids.js || true

      - name: Restart server
        run: |
          cd ~/Sky
          pm2 delete sky || true
          pm2 start npm \
            --name sky \
            --cwd /home/mitv/Sky \
            -- run start:prod
          pm2 save
